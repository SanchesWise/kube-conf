# 1. Плагины (Обязательно для S3/MinIO)
initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:v1.9.0
    volumeMounts:
      - mountPath: /target
        name: plugins

# 2. Конфигурация (Исправленная структура)
configuration:
  backupStorageLocation:
    - name: default
      provider: aws # ✅ Провайдер переехал сюда
      bucket: velero-backups
      config:
        region: us-east-1
        s3ForcePathStyle: "true"
        s3Url: http://minio.minio.svc.cluster.local:9000
        publicUrl: https://minio.ccsfarm.local
        
  volumeSnapshotLocation:
    - name: default
      provider: aws # ✅ И сюда
      config:
        region: us-east-1

# 3. Учетные данные
credentials:
  useSecret: true
  secretContents:
    cloud: |
      [default]
      aws_access_key_id = loki
      aws_secret_access_key = FeerDe3o

# 4. Настройка агентов (File System Backup для NFS)
# В новых версиях это называется deployNodeAgent (ранее deployRestic)
deployNodeAgent: true

# Принудительно используем FS Backup (Restic/Kopia) для всех томов по умолчанию,
# так как NFS не поддерживает снапшоты "железа".
defaultVolumesToFsBackup: true

# 5. Ресурсы
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 1024Mi

# 6. Расписание
schedules:
  daily-full:
    disabled: false
    schedule: "0 3 * * *"
    template:
      ttl: "720h"
      includedNamespaces:
        - "*"
      snapshotVolumes: true