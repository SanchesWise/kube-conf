–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CRI-O –∏ kubelet –º–æ–∂–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∞. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –∫–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

## üéØ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CRI-O

### 1. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞**

–°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
sudo cat <<'EOF' | sudo tee /etc/crio/crio.conf.d/10-optimization.conf
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
[crio.runtime]
# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—Ä–∞–∑–æ–≤
pids_limit = 4096
log_size_max = 134217728  # 128MB

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å rootless (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
manage_ns_lifecycle = false

[crio.image]
# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–æ–≤
parallel_downloads = 3

# –ü–æ–ª–∏—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –æ–±—Ä–∞–∑–æ–≤
image_cleanup_delay = "48h"
insecure_volumes = []

[crio.network]
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏
network_dir = "/etc/cni/net.d/"
plugin_dirs = ["/opt/cni/bin/"]

[crio.metrics]
# –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
enable_metrics = true
metrics_port = 9537

[crio.stats]
# –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
collect_stats = true
stats_collection_period = 10
EOF
```

### 2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è CRI-O**

```bash
sudo mkdir -p /etc/systemd/system/crio.service.d/

sudo cat <<'EOF' | sudo tee /etc/systemd/system/crio.service.d/limits.conf
[Service]
# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ CRI-O
MemoryMax=2G
MemoryHigh=1.5G

# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º CPU
CPUQuota=200%

# –õ–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
TasksMax=infinity

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
LimitNOFILE=infinity
LimitNPROC=infinity
EOF
```

## üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Kubelet

### 1. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è kubelet**

```bash
# –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo cp /var/lib/kubelet/config.yaml /var/lib/kubelet/config.yaml.backup

# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo cat <<'EOF' | sudo tee /var/lib/kubelet/config.yaml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
serializeImagePulls: false
maxPods: 250
podsPerCore: 0
podPidsLimit: -1

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ eviction –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ —Ä–µ—Å—É—Ä—Å–æ–≤
evictionHard:
  memory.available: "200Mi"
  nodefs.available: "10%"
  nodefs.inodesFree: "5%"
  imagefs.available: "15%"
evictionSoft:
  memory.available: "500Mi"
  nodefs.available: "15%"
  nodefs.inodesFree: "10%"
evictionSoftGracePeriod:
  memory.available: "2m"
  nodefs.available: "2m"
  nodefs.inodesFree: "2m"
evictionMaxPodGracePeriod: 90
evictionPressureTransitionPeriod: "1m"

# Garbage collection
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: "2m0s"

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging:
  format: text
  flushFrequency: 5s

# –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
    cacheTTL: "2m0s"
  x509:
    clientCAFile: "/etc/kubernetes/pki/ca.crt"

authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: "5m0s"
    cacheUnauthorizedTTL: "30s"

# –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã
systemReserved:
  cpu: "100m"
  memory: "512Mi"
  ephemeral-storage: "1Gi"
kubeReserved:
  cpu: "100m"
  memory: "512Mi"
  ephemeral-storage: "1Gi"
reservedSystemCPUs: ""

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
containerLogMaxSize: "100Mi"
containerLogMaxFiles: 5

# CRI
containerRuntimeEndpoint: "unix:///var/run/crio/crio.sock"
EOF
```

### 2. **Systemd –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è kubelet**

```bash
sudo mkdir -p /etc/systemd/system/kubelet.service.d/

sudo cat <<'EOF' | sudo tee /etc/systemd/system/kubelet.service.d/optimization.conf
[Service]
# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
MemoryMax=4G
MemoryHigh=3G
CPUQuota=300%

# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞
Nice=-10
OOMScoreAdjust=-999

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã
LimitNOFILE=1048576
LimitNPROC=infinity
LimitCORE=infinity

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–±–æ—è—Ö
Restart=always
RestartSec=10

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ OOM
OOMPolicy=kill
EOF
```

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ç–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ sysctl –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–µ—Ç–µ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```bash
sudo cat <<'EOF' | sudo tee /etc/sysctl.d/99-kubernetes-optimization.conf
# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 65536

# –£–ª—É—á—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É TCP
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±—É—Ñ–µ—Ä—ã
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 16384 16777216

# –£–ª—É—á—à–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ç–∏
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è overlay —Å–µ—Ç–µ–π
net.ipv4.neigh.default.gc_thresh1 = 8192
net.ipv4.neigh.default.gc_thresh2 = 32768
net.ipv4.neigh.default.gc_thresh3 = 65536

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã inotify –¥–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 256

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
fs.file-max = 2097152
EOF

# –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
sudo sysctl -p /etc/sysctl.d/99-kubernetes-optimization.conf
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

```bash
sudo cat <<'EOF' | sudo tee /usr/local/bin/check-optimization.sh
#!/bin/bash

echo "=== CRI-O Optimization Check ==="
echo "Parallel downloads: $(sudo crio config | grep parallel_downloads | cut -d'=' -f2)"
echo "PIDs limit: $(sudo crio config | grep pids_limit | cut -d'=' -f2)"
echo "Log size max: $(sudo crio config | grep log_size_max | cut -d'=' -f2)"

echo -e "\n=== Kubelet Optimization Check ==="
echo "Max pods: $(sudo kubectl get nodes -o jsonpath='{.items[0].status.capacity.pods}')"
echo "Serialize image pulls: $(sudo cat /var/lib/kubelet/config.yaml | grep serializeImagePulls | awk '{print $2}')"

echo -e "\n=== System Limits ==="
echo "File descriptors: $(ulimit -n)"
echo "Process limits: $(ulimit -u)"

echo -e "\n=== Memory Usage ==="
free -h

echo -e "\n=== Container Count ==="
sudo crictl ps -q | wc -l | xargs echo "Running containers:"
EOF

sudo chmod +x /usr/local/bin/check-optimization.sh
```

## üõ†Ô∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:

```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º systemd –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo systemctl daemon-reload

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º CRI-O
sudo systemctl restart crio
sudo systemctl status crio

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º kubelet
sudo systemctl restart kubelet
sudo systemctl status kubelet

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–∑–ª—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ Ready
sudo kubectl get nodes
```

## üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production

### –î–ª—è production –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ:

```bash
sudo cat <<'EOF' | sudo tee /etc/crio/crio.conf.d/20-production.conf
[crio.runtime]
# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è production
cgroup_manager = "systemd"
conmon_cgroup = "pod"
hooks_dir = ["/usr/share/containers/oci/hooks.d"]

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
selinux = true
seccomp_use_default_when_empty = true

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ JSON –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
log_format = "json"

[crio.metrics]
# –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
enable_metrics = true
metrics_port = 9537
metrics_socket = ""
metrics_cert = ""
metrics_key = ""

[crio.stats]
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
collect_stats = true
stats_collection_period = 30
EOF
```

## üí° –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** –∑–∞ —Å—á–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
2. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤
3. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏** —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ eviction
4. **–£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–µ—Ç–µ–≤–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
5. **–õ—É—á—à–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

## üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
# –ó–∞–ø—É—Å—Ç–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
sudo /usr/local/bin/check-optimization.sh

# –ü—Ä–æ–≤–µ—Ä–∏–º –º–µ—Ç—Ä–∏–∫–∏ CRI-O
curl -s http://localhost:9537/metrics | head -20

# –ü—Ä–æ–≤–µ—Ä–∏–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–æ–≤
time sudo kubectl run test-pod --image=busybox --restart=Never -- sleep 3600
```

**–†–µ–∫–æ–º–µ–Ω–¥—É—é –ø—Ä–∏–º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—ç—Ç–∞–ø–Ω–æ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è**, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞.