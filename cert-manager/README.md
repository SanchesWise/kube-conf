–≠—Ç–æ –º—É–¥—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ. –ë–æ—Ä—å–±–∞ —Å `insecure-registry` –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å—Ç–µ–∫–µ (CRI-O + Kubelet + Containerd) —á–∞—Å—Ç–æ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∞–¥, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —É–∂–µ—Å—Ç–æ—á–∞—é—Ç—Å—è.

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ **–¶–µ–Ω—Ç—Ä–∞ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (Internal CA)** —á–µ—Ä–µ–∑ `cert-manager` ‚Äî —ç—Ç–æ "–∑–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç" –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤.

### –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (—á—Ç–æ –Ω–µ—É–¥–æ–±–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏–¥–µ—Ç—Å—è –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω), –º—ã —Å–¥–µ–ª–∞–µ–º **–æ–¥–∏–Ω –ö–æ—Ä–Ω–µ–≤–æ–π CA (Root CA)** –∫–ª–∞—Å—Ç–µ—Ä–∞.

1.  –°–æ–∑–¥–∞–¥–∏–º **SelfSigned Issuer** (—á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∞—Ç—å —Å–∞–º Root CA).
2.  –í—ã–ø—É—Å—Ç–∏–º **Root CA Certificate** (–≥–ª–∞–≤–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç).
3.  –°–æ–∑–¥–∞–¥–∏–º **CA Issuer** (–æ–Ω –±—É–¥–µ—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è Nexus, GitLab –∏ —Ç.–¥., –∏—Å–ø–æ–ª—å–∑—É—è Root CA).
4.  –í—ã–ø—É—Å—Ç–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è Nexus.
5.  **–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ:** –î–æ–±–∞–≤–∏–º Root CA –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞ –Ω–æ–¥–∞—Ö (RED OS).

---

### –®–∞–≥ 1. –°–æ–∑–¥–∞–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏ CA –≤ Kubernetes

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `pki-infrastructure.yaml` –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –µ–≥–æ.

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-issuer
spec:
  selfSigned: {}
---
# 2. –°–æ–∑–¥–∞–µ–º –ö–æ—Ä–Ω–µ–≤–æ–π –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (Root CA)
# –û–Ω –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ —Å–µ–∫—Ä–µ—Ç–µ ccsfarm-root-ca-secret –≤ namespace cert-manager
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: ccsfarm-root-ca
  namespace: cert-manager # –õ—É—á—à–µ –¥–µ—Ä–∂–∞—Ç—å –µ–≥–æ —Ç–∞–º, –≥–¥–µ —Å–∞–º cert-manager
spec:
  isCA: true
  commonName: "CCSFarm Internal Root CA" # –ò–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ/—Å–∏—Å—Ç–µ–º–µ
  secretName: ccsfarm-root-ca-secret
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer
    group: cert-manager.io
---
# 3. –°–æ–∑–¥–∞–µ–º CA ClusterIssuer
# –≠—Ç–æ —Ç–æ—Ç "—Å—Ç–∞–Ω–æ–∫", –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–µ—á–∞—Ç–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è Nexus, GitLab –∏ —Ç.–¥.
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: ccsfarm-ca-issuer
spec:
  ca:
    secretName: ccsfarm-root-ca-secret
    # –°–µ–∫—Ä–µ—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ç–æ–º –∂–µ namespace, –≥–¥–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω cert-manager
```

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ:
```bash
kubectl apply -f pki-infrastructure.yaml
```

### –®–∞–≥ 2. –í—ã–ø—É—Å–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è Nexus

–¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è `registry-nexus.ccsfarm.local`. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `nexus-certificate.yaml`.
*–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é, —á—Ç–æ Nexus —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ namespace `nexus` (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–ø—Ä–∞–≤—å—Ç–µ).*

```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: nexus-tls
  namespace: nexus # –í–ê–ñ–ù–û: Namespace –≥–¥–µ —Å—Ç–æ–∏—Ç Nexus
spec:
  secretName: nexus-tls-secret # –ö—É–¥–∞ cert-manager –ø–æ–ª–æ–∂–∏—Ç –≥–æ—Ç–æ–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
  dnsNames:
    - registry-nexus.ccsfarm.local
    - nexus.ccsfarm.local
  issuerRef:
    name: ccsfarm-ca-issuer
    kind: ClusterIssuer
    group: cert-manager.io
```

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ:
```bash
kubectl apply -f nexus-certificate.yaml
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å (–¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å `True`):
```bash
kubectl get certificate -n nexus
```

### –®–∞–≥ 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ingress Nexus

–¢–µ–ø–µ—Ä—å —Å–∫–∞–∂–µ–º Ingress-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à Ingress –¥–ª—è Nexus (Docker registry —á–∞—Å—Ç—å) –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ü–∏—é `tls`.

–ü—Ä–∏–º–µ—Ä –∫—É—Å–∫–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ Ingress:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nexus-registry-ingress
  namespace: nexus
  annotations:
    # –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±—ç–∫–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ HTTPS –∏–ª–∏ HTTP (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∞–º–æ–≥–æ Nexus)
    # –û–±—ã—á–Ω–æ Nexus —Å–ª—É—à–∞–µ—Ç HTTP –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–∞, –∞ SSL —Ç–µ—Ä–º–∏–Ω–∏—Ä—É–µ—Ç—Å—è –Ω–∞ Ingress
    nginx.ingress.kubernetes.io/proxy-body-size: "0" # –í–∞–∂–Ω–æ –¥–ª—è –ø—É—à–∞ –±–æ–ª—å—à–∏—Ö –æ–±—Ä–∞–∑–æ–≤
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - registry-nexus.ccsfarm.local
      secretName: nexus-tls-secret # –¢–æ—Ç —Å–µ–∫—Ä–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–ª cert-manager
  rules:
    - host: registry-nexus.ccsfarm.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: nexus-service # –í–∞—à–µ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
                port:
                  number: 8082
```

### –®–∞–≥ 4. üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ú–û–ú–ï–ù–¢: –î–æ–≤–µ—Ä–∏–µ –Ω–∞ –Ω–æ–¥–∞—Ö

–°–µ–π—á–∞—Å —É –≤–∞—Å –µ—Å—Ç—å HTTPS, –Ω–æ –æ–Ω "–Ω–µ–¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π" (–∫–∞–∫ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π). –ß—Ç–æ–±—ã CRI-O –∏ Docker –Ω–∞ –Ω–æ–¥–∞—Ö –Ω–µ —Ä—É–≥–∞–ª–∏—Å—å, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—à **Root CA** –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –û–°.

**–≠—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ –í–°–ï–• –Ω–æ–¥–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ (–∏ master, –∏ worker).**

1.  **–í—ã–≥—Ä—É–∑–∏–º Root CA –∏–∑ –∫—É–±–µ—Ä–∞ (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –º–∞—à–∏–Ω–µ —Å kubectl):**
    ```bash
    kubectl get secret ccsfarm-root-ca-secret -n cert-manager -o jsonpath='{.data.tls\.crt}' | base64 -d > ccsfarm-ca.crt
    ```

2.  **–°–∫–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª `ccsfarm-ca.crt` –Ω–∞ –≤—Å–µ –Ω–æ–¥—ã.**
    (–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `scp` –∏–ª–∏ Ansible).

3.  **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤ RED OS (RHEL/CentOS):**
    –ó–∞–π–¥–∏—Ç–µ –Ω–∞ –∫–∞–∂–¥—É—é –Ω–æ–¥—É –ø–æ SSH –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

    ```bash
    # –ö–æ–ø–∏—Ä—É–µ–º –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∞–Ω–∫–æ—Ä–æ–≤
    sudo cp ccsfarm-ca.crt /etc/pki/ca-trust/source/anchors/

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
    sudo update-ca-trust
    ```

4.  **–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ CRI-O:**
    CRI-O –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –Ω–æ–≤—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –û–° –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.
    ```bash
    sudo systemctl restart crio
    ```

### –®–∞–≥ 5. –ü—Ä–æ–≤–µ—Ä–∫–∞

1.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –Ω–æ–¥—ã:**
    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–µ—Ä–Ω—É—Ç—å Nexus —á–µ—Ä–µ–∑ curl —Å –Ω–æ–¥—ã. –û—à–∏–±–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.
    ```bash
    curl -v https://registry-nexus.ccsfarm.local/v2/
    ```
    –î–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ, –∑–∞–ø—Ä–æ—Å–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –Ω–æ **–Ω–µ** –¥–æ–ª–∂–µ–Ω —Å–∫–∞–∑–∞—Ç—å "SSL certificate problem").

2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Login:**
    –ù–∞ –º–∞—à–∏–Ω–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (–∏–ª–∏ –Ω–∞ –Ω–æ–¥–µ):
    ```bash
    docker login registry-nexus.ccsfarm.local -u <user> -p <pass>
    ```
    *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:* –ù–∞ –º–∞—à–∏–Ω–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (–≤–∞—à–µ–º –ü–ö) —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç `ccsfarm-ca.crt` –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ—Ä–Ω–µ–≤—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–≤ Windows –ø—Ä–æ—Å—Ç–æ –¥–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω—É—Ç—å -> "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç" -> "–ü–æ–º–µ—Å—Ç–∏—Ç—å –≤ –î–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ö–æ—Ä–Ω–µ–≤—ã–µ –¶–µ–Ω—Ç—Ä—ã").

### –ò—Ç–æ–≥
–¢–µ–ø–µ—Ä—å —É –≤–∞—Å "–≤–∑—Ä–æ—Å–ª–∞—è" PKI.
*   –ö–æ–≥–¥–∞ –≤—ã –∑–∞—Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ GitLab –∏–ª–∏ MinIO –Ω–∞ HTTPS, –≤–∞–º –ø—Ä–æ—Å—Ç–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å `Certificate` –≤ –∫—É–±–µ—Ä–µ –∏ —É–∫–∞–∑–∞—Ç—å `issuerRef: ccsfarm-ca-issuer`.
*   –ù–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–∞ –Ω–æ–¥–∞—Ö –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–µ –ø—Ä–∏–¥–µ—Ç—Å—è ‚Äî –æ–Ω–∏ —É–∂–µ –¥–æ–≤–µ—Ä—è—é—Ç –≤–∞—à–µ–º—É –ö–æ—Ä–Ω–µ–≤–æ–º—É CA.

–ö–æ–Ω–µ—á–Ω–æ. –í–æ—Ç —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å.

–Ø –¥–æ–±–∞–≤–∏–ª –≤ –Ω–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥ –¥–ª—è RED OS (RHEL).

### –°–∫—Ä–∏–ø—Ç: `deploy-cert.sh`

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `deploy-cert.sh` –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```bash
#!/bin/bash

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
CERT_NAME="ccsfarm-ca.crt"
IP_SUBNET="10.10.2"
START_IP=100
END_IP=106

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ
if [ ! -f "$CERT_NAME" ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: –§–∞–π–ª $CERT_NAME –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!${NC}"
    echo "–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: kubectl get secret ccsfarm-root-ca-secret -n cert-manager -o jsonpath='{.data.tls\.crt}' | base64 -d > $CERT_NAME"
    exit 1
fi

# 2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è SSH (—á—Ç–æ–±—ã –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å root)
echo -n "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è SSH –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ω–æ–¥–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, root –∏–ª–∏ user): "
read SSH_USER

if [ -z "$SSH_USER" ]; then
    echo -e "${RED}–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º${NC}"
    exit 1
fi

echo "----------------------------------------------------------------"
echo "–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å–∫–∞—Ç–∫—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –Ω–∞ –Ω–æ–¥—ã $IP_SUBNET.$START_IP - $IP_SUBNET.$END_IP"
echo "----------------------------------------------------------------"

for i in $(seq $START_IP $END_IP); do
    TARGET_IP="$IP_SUBNET.$i"
    
    echo -ne "–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–¥—ã ${TARGET_IP}... "

    # –ö–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ:
    # 1. –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–∞–π–ª –∏–∑ /tmp –≤ –ø–∞–ø–∫—É –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —è–∫–æ—Ä–µ–π
    # 2. –û–±–Ω–æ–≤–ª—è–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
    # 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º CRI-O
    # 4. –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    REMOTE_COMMANDS="sudo cp /tmp/$CERT_NAME /etc/pki/ca-trust/source/anchors/ && \
                     sudo update-ca-trust && \
                     sudo systemctl restart crio && \
                     rm -f /tmp/$CERT_NAME"

    # –®–∞–≥ –ê: –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ SCP –≤ /tmp (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ —Å—Ä–∞–∑—É –≤ /etc)
    scp -o StrictHostKeyChecking=no -q "$CERT_NAME" "${SSH_USER}@${TARGET_IP}:/tmp/"
    
    if [ $? -eq 0 ]; then
        # –®–∞–≥ –ë: –í—ã–ø–æ–ª–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É —á–µ—Ä–µ–∑ SSH
        ssh -o StrictHostKeyChecking=no -q "${SSH_USER}@${TARGET_IP}" "$REMOTE_COMMANDS"
        
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}[OK] –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, CRI-O –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω.${NC}"
        else
            echo -e "${RED}[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.${NC}"
        fi
    else
        echo -e "${RED}[ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø/–ø–∞—Ä–æ–ª—å).${NC}"
    fi
done

echo "----------------------------------------------------------------"
echo "–ì–æ—Ç–æ–≤–æ."
```

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

1.  **–°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º:**
    ```bash
    chmod +x deploy-cert.sh
    ```

2.  **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `ccsfarm-ca.crt` –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º.**
    –ï—Å–ª–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ —Å–Ω–æ–≤–∞:
    ```bash
    kubectl get secret ccsfarm-root-ca-secret -n cert-manager -o jsonpath='{.data.tls\.crt}' | base64 -d > ccsfarm-ca.crt
    ```

3.  **–ó–∞–ø—É—Å—Ç–∏—Ç–µ:**
    ```bash
    ./deploy-cert.sh
    ```

### –ù—é–∞–Ω—Å—ã

*   **–ü–∞—Ä–æ–ª–∏/–ö–ª—é—á–∏:** –°–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ—Å—Ç–∞, –µ—Å–ª–∏ —É –≤–∞—Å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤—Ö–æ–¥ –ø–æ SSH-–∫–ª—é—á–∞–º. –ï—Å–ª–∏ –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã ‚Äî –≤—Å—ë –ø—Ä–æ–ª–µ—Ç–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
*   **Sudo:** –ï—Å–ª–∏ –≤—ã –ø–æ–¥–∫–ª—é—á–∞–µ—Ç–µ—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º `root`, `sudo` —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤. –ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –Ω–µ–≥–æ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è, –∏–Ω–∞—á–µ —Å–∫—Ä–∏–ø—Ç –º–æ–∂–µ—Ç "–∑–∞–≤–∏—Å–Ω—É—Ç—å", –æ–∂–∏–¥–∞—è –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è sudo –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ (–∏–ª–∏ –ø—Ä–∏–¥–µ—Ç—Å—è –≤–≤–æ–¥–∏—Ç—å –µ–≥–æ 7 —Ä–∞–∑).

–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å. –ß—Ç–æ–±—ã –≤–∞—à –∫–æ–º–ø—å—é—Ç–µ—Ä (Windows) –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ CI/CD (Ubuntu) –¥–æ–≤–µ—Ä—è–ª–∏ —Ä–µ—Å—É—Ä—Å–∞–º –∫–ª–∞—Å—Ç–µ—Ä–∞ (Nexus, GitLab) –∏ –Ω–µ –≤—ã–¥–∞–≤–∞–ª–∏ –æ—à–∏–±–æ–∫ SSL, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—à –∫–æ—Ä–Ω–µ–≤–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (`ccsfarm-ca.crt`) –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ü–µ–Ω—Ç—Ä–æ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —ç—Ç–∏—Ö –û–°.

–í–æ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –æ–±–µ–∏—Ö —Å–∏—Å—Ç–µ–º.

---

### üêß Ubuntu / Debian

–í Ubuntu –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø–æ—Ö–æ–∂–∞ –Ω–∞ RHEL (Red OS), –Ω–æ –ø—É—Ç–∏ –∫ –ø–∞–ø–∫–∞–º –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è.

**1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `ccsfarm-ca.crt` –Ω–∞ –º–∞—à–∏–Ω—É.**

**2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é.**
Ubuntu —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–∞–ø–∫—É `/usr/local/share/ca-certificates/`. –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã —Ñ–∞–π–ª –∏–º–µ–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `.crt`.

```bash
sudo cp ccsfarm-ca.crt /usr/local/share/ca-certificates/ccsfarm-ca.crt
```

**3. –û–±–Ω–æ–≤–∏—Ç–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.**
–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–±–µ—Ä–µ—Ç –≤—Å–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª `ca-certificates.crt`:

```bash
sudo update-ca-certificates
```
*–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤—ã–≤–æ–¥: `1 added, 0 removed; done.`*

**4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Docker (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω).**
Docker –Ω–∞ Linux –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –Ω–æ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–∞—Å—Ç–æ –Ω—É–∂–µ–Ω —Ä–µ—Å—Ç–∞—Ä—Ç –¥–µ–º–æ–Ω–∞:
```bash
sudo systemctl restart docker
```

**5. –ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
curl -v https://registry-nexus.ccsfarm.local/v2/
```
–û—à–∏–±–∫–∏ `SSL certificate problem` –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.

---

### ü™ü Windows

–í Windows –µ—Å—Ç—å –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞: —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø—Ä–æ—â–µ) –∏ —á–µ—Ä–µ–∑ PowerShell (–±—ã—Å—Ç—Ä–µ–µ).

#### –°–ø–æ—Å–æ–± 1: –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (GUI)

1.  –ù–∞–∂–º–∏—Ç–µ **Win+R**, –≤–≤–µ–¥–∏—Ç–µ `certlm.msc` –∏ –Ω–∞–∂–º–∏—Ç–µ Enter. –û—Ç–∫—Ä–æ–µ—Ç—Å—è –æ—Å–Ω–∞—Å—Ç–∫–∞ "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã - –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä" (—Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞).
    *   *–ü–æ—á–µ–º—É –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä?* –ß—Ç–æ–±—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Ä–∞–±–æ—Ç–∞–ª –∏ –¥–ª—è –≤–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–ª—É–∂–± (–Ω–∞–ø—Ä–∏–º–µ—Ä, Docker Desktop Service).
2.  –í –¥–µ—Ä–µ–≤–µ —Å–ª–µ–≤–∞ –Ω–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É **"–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ—Ä–Ω–µ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏" (Trusted Root Certification Authorities)**.
3.  –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –µ—ë –∏ –Ω–∞–∂–º–∏—Ç–µ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –Ω–∞ –ø–∞–ø–∫—É **"–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã" (Certificates)** -> **–í—Å–µ –∑–∞–¥–∞—á–∏ (All Tasks)** -> **–ò–º–ø–æ—Ä—Ç (Import)**.
4.  –í –º–∞—Å—Ç–µ—Ä–µ –∏–º–ø–æ—Ä—Ç–∞:
    *   –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ñ–∞–π–ª `ccsfarm-ca.crt`.
    *   –ù–∞ —ç—Ç–∞–ø–µ "–•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤" —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–æ **"–ü–æ–º–µ—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ —Å–ª–µ–¥—É—é—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ"**: `–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ—Ä–Ω–µ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏`.
    *   –ù–∞–∂–º–∏—Ç–µ "–ì–æ—Ç–æ–≤–æ".

#### –°–ø–æ—Å–æ–± 2: PowerShell (–æ—Ç –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ PowerShell –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É (—É–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É):

```powershell
Import-Certificate -FilePath "C:\path\to\ccsfarm-ca.crt" -CertStoreLocation Cert:\LocalMachine\Root
```

#### –ù—é–∞–Ω—Å—ã –¥–ª—è Windows:

1.  **Docker Desktop:** –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤ Windows –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ **–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ Docker Desktop** (—á–µ—Ä–µ–∑ –∏–∫–æ–Ω–∫—É –≤ —Ç—Ä–µ–µ -> Restart), –∏–Ω–∞—á–µ –æ–Ω –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –Ω–æ–≤—ã–π CA.
2.  **–ë—Ä–∞—É–∑–µ—Ä—ã:**
    *   **Chrome / Edge:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ Windows. –ó–∞—Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ä–∞–∑—É.
    *   **Firefox:** –ò–º–µ–µ—Ç **—Å–≤–æ–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ** —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.
        *   *–í–∞—Ä–∏–∞–Ω—Ç –ê:* –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Firefox –Ω–∞–π—Ç–∏ "Certificates" -> "View Certificates" -> "Import" –∏ –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª.
        *   *–í–∞—Ä–∏–∞–Ω—Ç –ë (–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π):* –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Firefox –≤–∫–ª—é—á–∏—Ç—å –≥–∞–ª–æ—á–∫—É "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø—Ä–æ–∫—Å–∏" (–æ–±—ã—á–Ω–æ –≤–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö) –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `security.enterprise_roots.enabled = true` –≤ `about:config`.

---

### üöÄ –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (Smoke Test)

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–∞ –º–∞—à–∏–Ω–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (Windows/Ubuntu) –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –≤ Nexus:

```bash
docker login registry-nexus.ccsfarm.local:8082
# User: admin (–∏–ª–∏ –≤–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
# Pass: (–≤–∞—à –ø–∞—Ä–æ–ª—å –∏–∑ Nexus)
```

–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ `Login Succeeded` ‚Äî –ø–æ–∑–¥—Ä–∞–≤–ª—è—é! –í—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—É—Ä —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–ª—é—á–µ–π (PKI).