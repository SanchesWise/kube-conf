–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è (kubectl apply -f nexus-install.yaml):

–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–ø—É—Å–∫–∞: Nexus —Å—Ç–∞—Ä—Ç—É–µ—Ç –¥–æ–ª–≥–æ (2-5 –º–∏–Ω—É—Ç). –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø–æ–¥–æ–º: kubectl get pods -n nexus -w.

–£–∑–Ω–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:
kubectl exec -it -n nexus <–∏–º—è-–ø–æ–¥–∞> -- cat /nexus-data/admin.password

–ó–∞–π–¥–∏—Ç–µ –≤ UI: –û—Ç–∫—Ä–æ–π—Ç–µ http://nexus.ccsfarm.local (–ª–æ–≥–∏–Ω admin, –ø–∞—Ä–æ–ª—å –∏–∑ –ø—É–Ω–∫—Ç–∞ 2).

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Docker-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤–Ω—É—Ç—Ä–∏ Nexus (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
–°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: Create repository -> docker (hosted).
HTTP Port: –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø–æ—Å—Ç–∞–≤—å—Ç–µ –≥–∞–ª–æ—á–∫—É "HTTP" –∏ –≤–ø–∏—à–∏—Ç–µ –ø–æ—Ä—Ç 8082.
–í–∫–ª—é—á–∏—Ç–µ "Docker Bearer Token Realm" –≤ —Ä–∞–∑–¥–µ–ª–µ Security -> Realms.

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—ã (Docker/CRI-O):
–î–æ–±–∞–≤—å—Ç–µ registry-nexus.ccsfarm.local –≤ insecure-registries –Ω–∞ –≤—Å–µ—Ö –º–∞—à–∏–Ω–∞—Ö, —Ç–∞–∫ –∫–∞–∫ —É –≤–∞—Å –Ω–µ—Ç HTTPS.

–ù–∞ –º–∞—à–∏–Ω–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (–≥–¥–µ –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å docker push)
–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ /etc/docker/daemon.json (Linux) –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Docker Desktop:
code
JSON
{
  "insecure-registries" : ["registry.ccsfarm.local"]
}
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Docker: sudo systemctl restart docker.

–í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ: –í–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ 10-crio.conf (–∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞–∫–µ—Ç–∞ CRI-O), –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, 99-local-insecure.conf) –≤ —Ç–æ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. CRI-O –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ .d/ –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏—Ö.
–Ø –¥–æ–±–∞–≤–∏–ª –≤ —Å–∫—Ä–∏–ø—Ç —Å—Ä–∞–∑—É –¥–≤–∞ –∞–¥—Ä–µ—Å–∞:
registry.ccsfarm.local (–æ –∫–æ—Ç–æ—Ä–æ–º –≤—ã —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ).
registry-nexus.ccsfarm.local (–¥–ª—è Nexus, –∫–æ—Ç–æ—Ä—ã–π –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏ –≤—ã—à–µ), —á—Ç–æ–±—ã –≤–∞–º –Ω–µ –ø—Ä–∏—à–ª–æ—Å—å –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–≤–∞–∂–¥—ã.
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä setup-crio.sh, —Å–¥–µ–ª–∞–π—Ç–µ –µ–≥–æ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º (chmod +x setup-crio.sh) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö —Å –ø—Ä–∞–≤–∞–º–∏ root.


#!/bin/bash

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
CRIO_CONF_DIR="/etc/crio/crio.conf.d"
# –ò–º—è —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å 99, —á—Ç–æ–±—ã —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏
TARGET_FILE="$CRIO_CONF_DIR/99-local-insecure.conf"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then 
  echo "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ root (sudo)"
  exit 1
fi

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Insecure Registry –¥–ª—è CRI-O..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –µ—ë –Ω–µ—Ç
if [ ! -d "$CRIO_CONF_DIR" ]; then
  echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ $CRIO_CONF_DIR..."
  mkdir -p "$CRIO_CONF_DIR"
fi

# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üìù –ó–∞–ø–∏—Å—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ $TARGET_FILE..."

cat <<EOF > "$TARGET_FILE"
# –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö registry
[crio.image]
insecure_registries = [
  "registry.ccsfarm.local",
  "registry-nexus.ccsfarm.local"
]
EOF

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å CRI-O –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
if systemctl is-active --quiet crio; then
  echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ CRI-O (reload)..."
  systemctl reload crio
  echo "‚úÖ CRI-O –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ."
else
  echo "‚ö†Ô∏è CRI-O –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞..."
  systemctl enable --now crio
  echo "‚úÖ CRI-O –∑–∞–ø—É—â–µ–Ω."
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
echo "üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ insecure_registries:"
crio config | grep insecure_registries -A 3 || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ crio config, –Ω–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω."

echo "üéâ –ì–æ—Ç–æ–≤–æ! Registry –¥–æ–±–∞–≤–ª–µ–Ω—ã."
–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ SSH)
–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ SSH –∫–æ –≤—Å–µ–º –Ω–æ–¥–∞–º —Å –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã, –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π (—Ü–∏–∫–ª–æ–º):

for ip in 10.10.2.101 10.10.2.102 10.10.2.103 10.10.2.104 10.10.2.105 10.10.2.106 10.10.2.100; do
  echo "Deploying to $ip..."
  ssh ccsfarm@$ip "sudo -S bash -c 'mkdir -p /etc/crio/crio.conf.d && echo -e \"[crio.image]\ninsecure_registries = [\\\"registry.ccsfarm.local\\\", \\\"registry-nexus.ccsfarm.local\\\"]\" > /etc/crio/crio.conf.d/99-local-insecure.conf && systemctl reload crio'"
done