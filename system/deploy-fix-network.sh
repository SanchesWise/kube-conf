#!/bin/bash

# ==============================================================================
# –ú–ê–°–°–û–í–ê–Ø –†–ê–°–ö–ê–¢–ö–ê –§–ò–ö–°–ê –°–ï–¢–ò (ETHTOOL)
# ==============================================================================

# 1. –°–ü–ò–°–û–ö –¶–ï–õ–ï–í–´–• –ù–û–î
# –í–ø–∏—à–∏—Ç–µ —Å—é–¥–∞ IP –∞–¥—Ä–µ—Å–∞ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –Ω–æ–¥ (Control Plane + Workers)
# –¢–µ–∫—É—â—É—é –Ω–æ–¥—É (Master) –º–æ–∂–Ω–æ –Ω–µ –≤–ø–∏—Å—ã–≤–∞—Ç—å, –µ—Å–ª–∏ –≤—ã –Ω–∞ –Ω–µ–π —É–∂–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏ —Ñ–∏–∫—Å.
NODES=(
    "10.10.2.101" # k8s-control01
    "10.10.2.102" # k8s-control02
    "10.10.2.103" # k8s-worker01
    "10.10.2.104" # k8s-worker02
    "10.10.2.105" # k8s-worker03
    "10.10.2.106" # k8s-worker04
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
USER="ccsfarm"
SCRIPT_TO_SEND="fix-network-offload.sh"
REMOTE_DEST="/home/$USER/$SCRIPT_TO_SEND"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
if [ ! -f "$SCRIPT_TO_SEND" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª $SCRIPT_TO_SEND –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ!"
    exit 1
fi

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å–∫–∞—Ç–∫—É —Å–∫—Ä–∏–ø—Ç–∞ $SCRIPT_TO_SEND –Ω–∞ ${#NODES[@]} –Ω–æ–¥..."
echo "---------------------------------------------------"

for NODE in "${NODES[@]}"; do
    echo "üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–æ–¥–µ: $NODE"

    # 1. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ (SCP)
    echo "   -> –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞..."
    scp -o StrictHostKeyChecking=no -q "$SCRIPT_TO_SEND" "$USER@$NODE:$REMOTE_DEST"
    
    if [ $? -eq 0 ]; then
        echo "   -> ‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ."
    else
        echo "   -> ‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ $NODE. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH."
        continue
    fi

    # 2. –£–¥–∞–ª–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ (SSH + SUDO)
    echo "   -> –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è)..."
    ssh -o StrictHostKeyChecking=no "$USER@$NODE" "chmod +x $REMOTE_DEST && sudo $REMOTE_DEST"

    if [ $? -eq 0 ]; then
        echo "   -> ‚úÖ –ù–æ–¥–∞ $NODE —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–ø–∞—Ç—á–µ–Ω–∞."
    else
        echo "   -> ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –Ω–∞ $NODE."
    fi
    echo "---------------------------------------------------"
done

echo "üèÅ –†–∞—Å–∫–∞—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."