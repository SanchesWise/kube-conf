–≠—Ç–æ —Å–∞–º–∞—è –ø–æ–ª–µ–∑–Ω–∞—è —á–∞—Å—Ç—å —Ä–∞–±–æ—Ç—ã ‚Äî **–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç**.

–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ª–æ–≥–æ–≤ —è —Å–æ—Å—Ç–∞–≤–∏–ª **¬´–ë–æ–µ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é (Playbook)¬ª** –¥–ª—è –≤–∞—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ—ë –≤ Confluence, Wiki –∏–ª–∏ README —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

---

# üõ°Ô∏è BOE–í–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ DNS –≤ CCSFARM (Proxmox/K8s)

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ö–ª–∞—Å—Ç–µ—Ä —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –ø–æ–≤–µ—Ä—Ö Proxmox. –°–µ—Ç—å Calico. DNS –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–≤—è–∑–∫–µ NodeLocalDNS -> CoreDNS -> BIND.
**–ì–ª–∞–≤–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:**
1.  –°–µ—Ç–µ–≤–æ–π —Å—Ç–µ–∫ Proxmox (VirtIO) –º–æ–∂–µ—Ç –±–∏—Ç—å UDP –ø–∞–∫–µ—Ç—ã.
2.  –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –¥–∏—Å–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ —É–±–∏–≤–∞–µ—Ç etcd, —á—Ç–æ –ª–æ–º–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ DNS.
3.  Kubernetes –∏–Ω–æ–≥–¥–∞ "–∑–∞–±—ã–≤–∞–µ—Ç" —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ IP –∏–∑ —Å–µ—Ä–≤–∏—Å–∞ (Ghost Endpoints).

---

## üü¢ 1. –≠–¢–ê–õ–û–ù–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)

–ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –∑–¥–æ—Ä–æ–≤–∞, —ç—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

### –ê. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≠–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (–ö–†–ò–¢–ò–ß–ù–û)
```bash
kubectl get endpoints kube-dns -n kube-system
```
*   **–ù–æ—Ä–º–∞:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ IP-–∞–¥—Ä–µ—Å–æ–≤ –≤ `ENDPOINTS` —Å—Ç—Ä–æ–≥–æ —Ä–∞–≤–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø–æ–¥–æ–≤ CoreDNS (—Å–µ–π—á–∞—Å –∏—Ö **2**).
*   **–ê–≤–∞—Ä–∏—è:** –ï—Å–ª–∏ –ø–æ–¥–æ–≤ 2, –∞ –∞–¥—Ä–µ—Å–æ–≤ 7 (–∏–ª–∏ –±–æ–ª—å—à–µ) ‚Äî —Ç—Ä–∞—Ñ–∏–∫ –ª–µ—Ç–∏—Ç –≤ "—á–µ—Ä–Ω—É—é –¥—ã—Ä—É".

### –ë. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
```bash
kubectl get pods -n kube-system -l k8s-app=kube-dns -o wide
```
*   **–ù–æ—Ä–º–∞:** –ü–æ–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `Running`. –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –Ω–∞ **Worker** –Ω–æ–¥–∞—Ö, –∞ –Ω–µ –Ω–∞ Master (—Ö–æ—Ç—è —Å–µ–π—á–∞—Å —É –≤–∞—Å –æ–¥–∏–Ω –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ, —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ, –ø–æ–∫–∞ –¥–∏—Å–∫ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è).

### –í. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Å–µ—Ç–∏
```bash
ethtool -k ens18 | grep tx-checksumming
```
*   **–ù–æ—Ä–º–∞:** `off`.
*   **–†–∏—Å–∫:** –í –≤–∞—à–∏—Ö –ª–æ–≥–∞—Ö —Å–µ–π—á–∞—Å `on`. –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ –º—ã –≤–∫–ª—é—á–∏–ª–∏ `force_tcp`. –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è –Ω–∞ UDP, DNS —Å–Ω–æ–≤–∞ —É–ø–∞–¥–µ—Ç.

---

## üö® 2. –°–¶–ï–ù–ê–†–ò–ò –ê–í–ê–†–ò–ô –ò –õ–ï–ß–ï–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–π –ê: "DNS —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ –∏–ª–∏ —á–µ—Ä–µ–∑ —Ä–∞–∑ (50% –ø–æ—Ç–µ—Ä—å)"
**–°–∏–º–ø—Ç–æ–º:** `Could not resolve host` –≤ GitLab Runner, –æ—à–∏–±–∫–∏ `connection refused` –≤ –ª–æ–≥–∞—Ö NodeLocalDNS.
**–ü—Ä–∏—á–∏–Ω–∞:** "–§–∞–Ω—Ç–æ–º–Ω—ã–µ" (Ghost) —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã. –°–µ—Ä–≤–∏—Å —à–ª–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ IP —É–º–µ—Ä—à–∏—Ö –ø–æ–¥–æ–≤.

**üîß –õ–ï–ß–ï–ù–ò–ï (Copy-Paste):**
```bash
# 1. –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç Endpoints (Kubernetes –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç –µ–≥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
kubectl delete endpoints kube-dns -n kube-system

# 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–µ—à–∏—Ä—É—é—â–∏–µ –ø–æ–¥—ã
kubectl rollout restart daemonset nodelocaldns -n kube-system

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
kubectl get endpoints kube-dns -n kube-system
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π –ë: "DNS —É–º–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é, i/o timeout –≤ –ª–æ–≥–∞—Ö"
**–°–∏–º–ø—Ç–æ–º:** –í –ª–æ–≥–∞—Ö CoreDNS —Å–ø–ª–æ—à–Ω—ã–µ `read udp ... i/o timeout`.
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ—Ç–µ—Ä—è –ø–∞–∫–µ—Ç–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä–∞ Proxmox –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ MTU.

**üîß –õ–ï–ß–ï–ù–ò–ï:**

**–®–∞–≥ 1. –í—ã–∫–ª—é—á–∏—Ç—å Checksum Offload (–Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö):**
```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ Master –∏ –≤—Å–µ—Ö Workers
ethtool -K ens18 tx off
```

**–®–∞–≥ 2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–∫–ª—é—á–µ–Ω TCP (–≤ –∫–æ–Ω—Ñ–∏–≥–µ):**
```bash
kubectl edit cm coredns -n kube-system
```
–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∑–æ–Ω—ã –µ—Å—Ç—å `force_tcp`:
```text
forward ccsfarm.local 10.10.1.151 {
   force_tcp
}
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π –í: "–¢–æ—Ç–∞–ª—å–Ω—ã–π —Å–±–æ–π (–ø–∞–¥–∞—é—Ç API, Etcd –∏ DNS)"
**–°–∏–º–ø—Ç–æ–º:** `kubectl` —Ç–æ—Ä–º–æ–∑–∏—Ç, –ø–æ–¥—ã `etcd` –∏ `apiserver` –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–µ—Å—Ç–∞—Ä—Ç—è—Ç—Å—è.
**–ü—Ä–∏—á–∏–Ω–∞:** –ú–µ–¥–ª–µ–Ω–Ω—ã–π –¥–∏—Å–∫ –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ (Latency –¥–∏—Å–∫–∞ > 10ms).

**üîß –õ–ï–ß–ï–ù–ò–ï:**

**–®–∞–≥ 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–∏—Å–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ:**
```bash
dd if=/dev/zero of=testfile bs=4k count=1000 oflag=dsync
```
*   –ï—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å < 5 MB/s ‚Äî —ç—Ç–æ –ø—Ä–∏—á–∏–Ω–∞ –∞–≤–∞—Ä–∏–∏.

**–®–∞–≥ 2. –¢—é–Ω–∏–Ω–≥ Proxmox (–¥–ª—è VM Master):**
1.  **Stop VM**.
2.  Hardware -> Disk -> **Cache: Write back** (–µ—Å–ª–∏ –µ—Å—Ç—å UPS) –∏–ª–∏ **IO Thread: On**.
3.  Hardware -> Processors -> **CPU Units: 2048** (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –º–∞—Å—Ç–µ—Ä—É).
4.  **Start VM**.

**–®–∞–≥ 3. –î–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è Etcd (–û—á–∏—Å—Ç–∫–∞):**
```bash
ETCD_ID=$(sudo crictl ps --name etcd -q | head -n 1)
sudo crictl exec $ETCD_ID etcdctl defrag --cluster --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key
```

---

## üß™ 3. –°–ö–†–ò–ü–¢ –ë–´–°–¢–†–û–ô –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–∏–∫. –í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ, –æ–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ DNS –∏–∑–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞:

```bash
kubectl run -i --tty --rm dns-debug --image=busybox:1.28 --restart=Never -- sh -c 'echo "--- /etc/resolv.conf ---"; cat /etc/resolv.conf; echo "--- TEST 1: Internal ---"; nslookup kubernetes.default; echo "--- TEST 2: External (Through TCP) ---"; nslookup gitlab.ccsfarm.local'
```

*   –ï—Å–ª–∏ **TEST 1** –ø–∞–¥–∞–µ—Ç -> –ü—Ä–æ–±–ª–µ–º–∞ –≤–Ω—É—Ç—Ä–∏ (Endpoints, Calico).
*   –ï—Å–ª–∏ **TEST 2** –ø–∞–¥–∞–µ—Ç -> –ü—Ä–æ–±–ª–µ–º–∞ —Å–Ω–∞—Ä—É–∂–∏ (—Å–≤—è–∑—å —Å BIND, Proxmox Network).

–ü–æ–Ω—è–ª. –î–∞, –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö `nodelocaldns` (—Ç–∏–ø–∞ `connect: connection refused` –∏–ª–∏ `i/o timeout`) ‚Äî —ç—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–∏ –∏–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤**. –û–Ω –æ—á–µ–Ω—å "—à—É–º–Ω—ã–π", –∫–æ–≥–¥–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∏ —Å –∞–ø—Å—Ç—Ä–∏–º–∞–º–∏. –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã `nslookup` –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ (–∫–∞–∫ –º—ã –≤–∏–¥–µ–ª–∏ ‚Äî 20/20), –Ω–∞ —ç—Ç–∏ –ª–æ–≥–∏ –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –≥–ª–∞–∑–∞ (—ç—Ç–æ "—ç—Ö–æ" –≤–æ–π–Ω—ã).

–ù–∏–∂–µ ‚Äî **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞ (Snapshot)** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ DNS. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã. –≠—Ç–æ –±—É–¥–µ—Ç –≤–∞—à–µ–π "–¢–æ—á–∫–æ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è".

---

# üì∏ –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –°–±–æ—Ä —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ DNS

–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –¥–ª—è –±—ç–∫–∞–ø–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç. –û–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ø—Ä–∞–≤–∏–ª–∏ (ConfigMaps, Endpoints, Network settings).

### 1. –°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (Run on Master)

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ —Ü–µ–ª–∏–∫–æ–º –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –º–∞—Å—Ç–µ—Ä–∞:

```bash
# 1. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –¥–∞—Ç–æ–π
BACKUP_DIR="dns_backup_$(date +%Y%m%d_%H%M)"
mkdir -p $BACKUP_DIR
echo "Saving snapshot to $BACKUP_DIR..."

# 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º ConfigMaps (–ù–∞—Å—Ç—Ä–æ–π–∫–∏ CoreDNS –∏ NodeLocalDNS)
# –≠—Ç–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ: —Ç—É—Ç force_tcp, forwarders –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∞
kubectl get cm coredns -n kube-system -o yaml > $BACKUP_DIR/coredns-config.yaml
kubectl get cm nodelocaldns -n kube-system -o yaml > $BACKUP_DIR/nodelocaldns-config.yaml

# 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ Endpoints (–ß—Ç–æ–±—ã —Å–≤–µ—Ä–∏—Ç—å IP –∞–¥—Ä–µ—Å–∞ –≤ –±—É–¥—É—â–µ–º)
# –ï—Å–ª–∏ —Ç—É—Ç –±—É–¥–µ—Ç –±–æ–ª—å—à–µ IP, —á–µ–º –ø–æ–¥–æ–≤ - —ç—Ç–æ –∞–≤–∞—Ä–∏—è "Ghost Endpoints"
kubectl get endpoints kube-dns -n kube-system -o yaml > $BACKUP_DIR/endpoints-state.yaml

# 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º Deployment –∏ DaemonSet (–ß—Ç–æ–±—ã –ø–æ–º–Ω–∏—Ç—å affinity –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∑–∞–ø—É—Å–∫–∞)
kubectl get deployment coredns -n kube-system -o yaml > $BACKUP_DIR/coredns-deployment.yaml
kubectl get daemonset nodelocaldns -n kube-system -o yaml > $BACKUP_DIR/nodelocaldns-daemonset.yaml

# 5. –°–Ω–∏–º–∞–µ–º —ç—Ç–∞–ª–æ–Ω resolv.conf –∏–∑–Ω—É—Ç—Ä–∏ –ü–æ–¥–∞ (–ü—Ä–æ–≤–µ—Ä–∫–∞ ndots)
# –≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç, –∫–∞–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DNS —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∏–ª–µ—Ç–∞—é—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
kubectl run -i --tty --rm snapshot-resolv --image=busybox:1.28 --restart=Never -- cat /etc/resolv.conf > $BACKUP_DIR/pod-resolv-conf.txt

# 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ù–û–î–´ (MTU –∏ Offload)
# –í–ê–ñ–ù–û: –≠—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—Ç–µ—Ä–∞. –ï—Å–ª–∏ –≤–æ—Ä–∫–µ—Ä—ã –æ—Ç–ª–∏—á–∞—é—Ç—Å—è, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–∞–º –≤—Ä—É—á–Ω—É—é.
echo "--- IP LINK (MTU) ---" > $BACKUP_DIR/node-net-settings.txt
ip link show >> $BACKUP_DIR/node-net-settings.txt
echo -e "\n--- ETHTOOL (TX OFFLOAD) ---" >> $BACKUP_DIR/node-net-settings.txt
# –ó–∞–º–µ–Ω–∏—Ç–µ ens18 –Ω–∞ –≤–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –µ—Å–ª–∏ –æ–Ω –¥—Ä—É–≥–æ–π
ethtool -k ens18 | grep tx-checksumming >> $BACKUP_DIR/node-net-settings.txt

echo "‚úÖ Backup completed in $BACKUP_DIR"
ls -lh $BACKUP_DIR
```

---

### 2. –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ —Ñ–∞–π–ª–∞—Ö (–ß–µ–∫-–ª–∏—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)

–ï—Å–ª–∏ —Å–ª—É—á–∏—Ç—Å—è –∞–≤–∞—Ä–∏—è, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –∏ —Å–≤–µ—Ä—å—Ç–µ —Å —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ:

#### –ê. `coredns-config.yaml`
–ò—â–∏—Ç–µ —Å–µ–∫—Ü–∏—é `forward . ...`:
*   **–í–∞–∂–Ω–æ:** –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∑–æ–Ω—ã —Å TCP.
    ```text
    forward ccsfarm.local 10.10.1.151 {
       force_tcp
    }
    ```

#### –ë. `nodelocaldns-config.yaml`
*   **–í–∞–∂–Ω–æ:** –í –±–ª–æ–∫–µ `cluster.local` —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `force_tcp` –≤–∫–ª—é—á–µ–Ω (–∏–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω, –∫–∞–∫ –º—ã —Ä–µ—à–∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏).
    ```text
    forward . 10.233.0.10 {
        force_tcp  # <-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ
    }
    ```

#### –í. `endpoints-state.yaml`
*   **–ö—Ä–∏—Ç–∏—á–Ω–æ:** –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ –ø–æ—Å—á–∏—Ç–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ `subsets -> addresses`.
*   –ò—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **—Å—Ç—Ä–æ–≥–æ 2** (–∏–ª–∏ —Å–∫–æ–ª—å–∫–æ —É –≤–∞—Å —Ä–µ–ø–ª–∏–∫ CoreDNS). –ï—Å–ª–∏ –∏—Ö —Ç–∞–º 5-7 ‚Äî –Ω—É–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –æ–±—ä–µ–∫—Ç Endpoints (`kubectl delete ep kube-dns -n kube-system`).

#### –ì. `node-net-settings.txt`
*   **–ö—Ä–∏—Ç–∏—á–Ω–æ:** `tx-checksumming: off`. –ï—Å–ª–∏ —Ç–∞–º `on` ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Proxmox/OS, –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å `ethtool -K ... tx off`.

---

### 3. –ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (Restore)

–ï—Å–ª–∏ –≤—ã —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–∏–ª–∏ –∏–ª–∏ –∏—Å–ø–æ—Ä—Ç–∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥–∏, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤ DNS
kubectl apply -f coredns-config.yaml
kubectl apply -f nodelocaldns-config.yaml

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–¥–æ–≤ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
kubectl rollout restart deployment coredns -n kube-system
kubectl rollout restart daemonset nodelocaldns -n kube-system
```