# ============================================================================
# Nexus 3 Architecture: SSD (System) + S3 (Blobs)
# ============================================================================

---
apiVersion: v1
kind: Namespace
metadata:
  name: nexus

---
# 1. Быстрый SSD диск только для базы и логов (Longhorn)
# Блобы здесь храниться НЕ БУДУТ, поэтому 10-20 ГБ хватит с головой.
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nexus-data-ssd
  namespace: nexus
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 10Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus
  namespace: nexus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexus
  template:
    metadata:
      labels:
        app: nexus
    spec:
      # Init: Исправляем права (нужно только для SSD тома)
      initContainers:
        - name: fix-permissions
          image: busybox:1.36
          command: 
            - sh
            - -c
            - >
              mkdir -p /nexus-data/blobs &&
              mkdir -p /nexus-data/javaprefs &&
              chown -R 200:200 /nexus-data &&
              chmod -R 755 /nexus-data
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: nexus-data-ssd
              mountPath: /nexus-data
        - name: configure-docker-connector
          image: busybox:1.36
          command:
          - sh
          - -c
          - |
            cat > /nexus-data/etc/nexus.properties << 'EOF'
            nexus-args=${jetty.etc}/jetty.xml,${jetty.etc}/jetty-https.xml,${jetty.etc}/jetty-requestlog.xml
            application-port=8081
            application-port-ssl=8443
            nexus.docker.enabled=true
            nexus.docker.v2.enabled=true
            nexus.docker.v2.port=5000
            EOF
            chown 200:200 /nexus-data/etc/nexus.properties
            chmod 644 /nexus-data/etc/nexus.properties
          volumeMounts:
          - name: nexus-data-ssd
            mountPath: /nexus-data
      containers:
        - name: nexus
          image: sonatype/nexus3:3.69.0  # Стабильная версия
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 200
            runAsGroup: 200
          ports:
            - containerPort: 8081
              name: ui
            - containerPort: 5000        # Порт для Docker
              name: docker-hosted
          env:
            - name: NEXUS_CONTEXT
              value: "/"
            # КРИТИЧНО: Фикс ошибки "Could not lock User prefs"
            - name: INSTALL4J_ADD_VM_PARAMS
              value: "-Xms2g -Xmx2g -XX:+UseG1GC -Djava.util.prefs.userRoot=/nexus-data/javaprefs"
          resources:
            requests:
              memory: "100Mi"
              cpu: "2"
            limits:
              memory: "800Mi"
              cpu: "4"              
          # Увеличенные таймауты
          livenessProbe:
            httpGet:
              path: /service/rest/v1/status
              port: 8081
            initialDelaySeconds: 120
            periodSeconds: 30
            failureThreshold: 10
          readinessProbe:
            httpGet:
              path: /service/rest/v1/status
              port: 8081
            initialDelaySeconds: 120
            periodSeconds: 30
            failureThreshold: 10
            
          volumeMounts:
            - name: nexus-data-ssd
              mountPath: /nexus-data

      volumes:
        - name: nexus-data-ssd
          persistentVolumeClaim:
            claimName: nexus-data-ssd

---
apiVersion: v1
kind: Service
metadata:
  name: nexus-service
  namespace: nexus
spec:
  selector:
    app: nexus
  type: ClusterIP
  ports:
    - name: ui
      port: 8081
      targetPort: 8081
    - name: docker
      port: 8082        # Внешний порт (на него смотрит Ingress)
      targetPort: 5000  # Внутренний порт

---

apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: nexus-tls
  namespace: nexus
spec:
  secretName: nexus-tls-secret
  duration: 8760h # 1 год
  renewBefore: 720h # 30 дней до истечения
  commonName: nexus.ccsfarm.local
  dnsNames:
    - nexus.ccsfarm.local
    - registry-nexus.ccsfarm.local
  issuerRef:
    name: ccsfarm-ca-issuer
    kind: ClusterIssuer

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nexus-ingress
  namespace: nexus
  annotations:
    cert-manager.io/issuer-group: cert-manager.io
    cert-manager.io/issuer-kind: ClusterIssuer
    cert-manager.io/issuer-name: ccsfarm-ca-issuer
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "900"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - registry-nexus.ccsfarm.local
        - nexus.ccsfarm.local
      secretName: nexus-tls-secret
  rules:
    - host: nexus.ccsfarm.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: nexus-service
                port:
                  number: 8081
    - host: registry-nexus.ccsfarm.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: nexus-service
                port:
                  number: 8082