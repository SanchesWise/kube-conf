deploymentMode: SimpleScalable

loki:
  auth_enabled: false

  memberlist:
    service: loki-memberlist
    join_members:
      - loki-memberlist

  storage:
    type: s3
    bucketNames:
      chunks: loki-data
      ruler: loki-data
      admin: loki-data
    s3:
      endpoint: http://minio.minio.svc.cluster.local:9000
      region: us-east-1
      s3forcepathstyle: true
      insecure: true

  # --- ГЛАВНОЕ ИЗМЕНЕНИЕ ---
  # Мы используем structuredConfig, чтобы напрямую внедрить настройки в config.yaml
  # Это отключает "магию" Helm-чарта и заставляет Loki работать точно по инструкции MinIO.
  structuredConfig:
    common:
      replication_factor: 2
      path_prefix: /var/loki
      ring:
        instance_addr: "${POD_IP}"
        kvstore:
          store: memberlist
      storage:
        s3:
          # Ссылка на MinIO
          endpoint: http://minio.minio.svc.cluster.local:9000
          bucketnames: loki-data
          region: us-east-1
          # Берем ключи из переменных окружения (которые мы передадим ниже)
          access_key_id: "${AWS_ACCESS_KEY_ID}"
          secret_access_key: "${AWS_SECRET_ACCESS_KEY}"
          # Жизненно важно для MinIO:
          s3forcepathstyle: true
          insecure: true
          http_config:
            idle_conn_timeout: 90s
            insecure_skip_verify: true
    ruler:
      enable_api: true
      enable_alertmanager_v2: true
      # Укажите здесь ваш реальный адрес Alertmanager
      alertmanager_url: http://kube-prometheus-stack-alertmanager.monitoring.svc.cluster.local:9093
      storage:
        type: s3 # Правила будут храниться там же, где и логи (в MinIO)
      ring:
        kvstore:
          store: memberlist
      rule_path: /var/loki/rules-temp

    # Схема хранения
    schema_config:
      configs:
        - from: 2024-04-01
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: index_
            period: 24h

    # Явное указание хранилища
    storage_config:
      tsdb_shipper:
        active_index_directory: /var/loki/index
        cache_location: /var/loki/index_cache
        cache_ttl: 24h
      aws:
        # Для обратной совместимости, хотя common.storage.s3 должно хватать
        endpoint: http://minio.minio.svc.cluster.local:9000
        region: us-east-1
        bucketnames: loki-data
        access_key_id: "${AWS_ACCESS_KEY_ID}"
        secret_access_key: "${AWS_SECRET_ACCESS_KEY}"
        s3forcepathstyle: true
        insecure: true

    compactor:
      working_directory: /var/loki/compactor
      shared_store: s3 
      compaction_interval: 10m
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150

    limits_config:
      retention_period: 14d

# --- КОМПОНЕНТЫ ---

write:
  replicas: 2
  persistence:
    enabled: true
    storageClass: managed-nfs-storage
    size: 10Gi
  # Обязательно разрешаем подстановку переменных в конфиг
  extraArgs:
    - -config.expand-env=true
  # Передаем только ключи и IP
  extraEnv:
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: AWS_ACCESS_KEY_ID
      value: loki
    - name: AWS_SECRET_ACCESS_KEY
      value: FeerDe3o
    # На всякий случай дублируем регион для SDK
    - name: AWS_REGION
      value: us-east-1

read:
  replicas: 2
  persistence:
    enabled: true
    storageClass: managed-nfs-storage
    size: 10Gi
  extraArgs:
    - -config.expand-env=true
  extraEnv:
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: AWS_ACCESS_KEY_ID
      value: loki
    - name: AWS_SECRET_ACCESS_KEY
      value: FeerDe3o
    - name: AWS_REGION
      value: us-east-1

backend:
  replicas: 2
  persistence:
    enabled: true
    storageClass: managed-nfs-storage
    size: 10Gi
  extraArgs:
    - -config.expand-env=true
  extraEnv:
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: AWS_ACCESS_KEY_ID
      value: loki
    - name: AWS_SECRET_ACCESS_KEY
      value: FeerDe3o
    - name: AWS_REGION
      value: us-east-1

gateway:
  enabled: true
  replicas: 2

monitoring:
  selfMonitoring:
    enabled: false
    lokiCanary:
      enabled: false
  serviceMonitor:
    enabled: true
    metricsInstance:
      enabled: false 
    namespace: monitoring
    labels:
      release: kube-prometheus-stack
    interval: 15s
    scrapeTimeout: 10s
  prometheusRule:
    enabled: true
    labels:
      release: prometheus
    rules:
      - alert: LokiRequestErrors
        expr: 100 * sum(rate(loki_request_duration_seconds_count{status_code=~"5.."}[1m])) / sum(rate(loki_request_duration_seconds_count[1m])) > 10
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Loki is returning > 10% 5xx errors"      
test:
  enabled: false